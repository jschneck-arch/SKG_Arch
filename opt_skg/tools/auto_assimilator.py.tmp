#!/usr/bin/env python3
"""
Auto-Assimilator (quorum-gated)
Scans overlay, validates, asks moon quorum, promotes on pass.
"""
import os, json, time, shutil, subprocess
from pathlib import Path
from skg.audit_coder import record as audit_coder
from skg.governance import evaluate_with_moons

OVERLAY = Path("/home/skg/.skg_overlay/patches")
TARGET  = Path("/opt/skg/skills")
REJECT  = OVERLAY / "rejected"
REJECT.mkdir(parents=True, exist_ok=True)

def _run_cmd(cmd, input_text=None, timeout=20):
    try:
        p = subprocess.run(cmd, shell=True, capture_output=True, text=True, timeout=timeout, input=input_text)
        return p.returncode, p.stdout, p.stderr
    except Exception as e:
        return 1, "", str(e)

def validate_skill_code(code:str) -> dict:
    # use validator if present
    rc, out, err = _run_cmd("python3 /opt/skg/tools/skill_validator.py", input_text=code, timeout=20)
    try:
        parsed = json.loads(out) if out else {"ok": False}
    except Exception:
        parsed = {"ok": False, "detail": "validator_output_invalid", "out": out[:200]}
    parsed.update({"rc": rc, "stdout": out, "stderr": err})
    return parsed

def main():
    if not OVERLAY.exists():
        return
    for f in sorted(OVERLAY.glob("*.py")):
        code = f.read_text()
        audit_coder("candidate", "auto_assimilator", str(f), code, {})
        vres = validate_skill_code(code)
        # ask moons
        quorum_res = evaluate_with_moons("validate_skill")
        audit_coder("vote_result","auto_assimilator", str(f), code, {"validator": vres, "quorum": quorum_res})
        # require both validator ok and quorum passed
        if vres.get("ok") and quorum_res.get("passed"):
            TARGET.mkdir(parents=True, exist_ok=True)
            dest = TARGET / f.name
            shutil.copy2(f, dest)
            audit_coder("promoted","auto_assimilator", str(dest), code, {"validator": vres, "quorum": quorum_res})
            try: f.unlink()
            except: pass
        else:
            audit_coder("rejected","auto_assimilator", str(f), code, {"validator": vres, "quorum": quorum_res})
            try:
                shutil.move(str(f), str(REJECT / f.name))
            except Exception:
                pass

if __name__=="__main__":
    main()
