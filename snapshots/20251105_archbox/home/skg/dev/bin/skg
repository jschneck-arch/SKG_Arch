#!/usr/bin/env bash
# SKG Control CLI – clean, validated

set -e
export SKG_DIR="/opt/skg"
export VENV="$SKG_DIR/.venv"
export PATH="$VENV/bin:$PATH"
export PYTHONPATH="$SKG_DIR:$PYTHONPATH"

SERVICE_CORE="skg-core-v4.service"
SERVICE_API="skg-api.service"

show_usage() {
  cat <<USAGE
Usage: skg <command> [args]
Core:      status | restart | reload | logs [core|api]
API:       skill run <name> [json] | api [state|journal]
Physics:   phase <PhaseName> | lfo <amp> <freq> <phi>
Coder:     code propose <desc> <file> | code apply <file>
Reflect:   reflect <keyword> [min_entropy]
Misc:      doctor | version
USAGE
}

cmd="${1:-help}"; shift || true

case "$cmd" in
  status)  systemctl status "$SERVICE_CORE" "$SERVICE_API" --no-pager ;;
  restart) systemctl restart "$SERVICE_CORE" "$SERVICE_API" ;;
  reload)  systemctl daemon-reload ;;
  logs)
    target="${1:-core}"
    case "$target" in
      core) journalctl -fu "$SERVICE_CORE" ;;
      api)  journalctl -fu "$SERVICE_API" ;;
      *) echo "Usage: skg logs [core|api]" ;;
    esac ;;
  skill)
    sub="${1:-}"; shift || true
    if [ "$sub" = run ]; then
      name="$1"; data="$2"
      curl -s -X POST -H "Content-Type: application/json" -d "$data" "http://127.0.0.1:5055/skill/$name"
    fi ;;
  api)
    sub="${1:-}"
    case "$sub" in
      state)   curl -s http://127.0.0.1:5055/state ;;
      journal) curl -s http://127.0.0.1:5055/journal ;;
      *) echo "Usage: skg api [state|journal]" ;;
    esac ;;
  phase)    exec "$VENV/bin/python" "$SKG_DIR/cli/phase.py" "$@" ;;
  lfo)      exec "$VENV/bin/python" "$SKG_DIR/cli/lfo.py" "$@" ;;
  code)     exec "$VENV/bin/python" "$SKG_DIR/cli/code.py" "$@" ;;
  reflect)  exec "$VENV/bin/python" "$SKG_DIR/cli/reflect.py" "$@" ;;
  doctor)
    echo "=== SKG Doctor ==="
    [ -x "$VENV/bin/python" ] && echo "✅ venv ok" || echo "❌ missing venv"
    for s in "$SERVICE_CORE" "$SERVICE_API"; do
      if systemctl is-active --quiet "$s"; then echo "✅ $s active"; else echo "⚠️ $s inactive"; fi
    done
    [ -d /var/lib/skg/memory ] && echo "✅ memory dir ok" || echo "❌ missing memory dir"
    [ -f /var/lib/skg/memory/governance.audit.jsonl ] && echo "✅ audit log" || echo "⚠️ no audit log yet"
    echo "Doctor complete." ;;
  version)  echo "SKG CLI $(date -u +%Y%m%d%H%M%S)" ;;
  help|-h|--help|"") show_usage ;;
  *) echo "Unknown command: $cmd"; show_usage ;;
esac
